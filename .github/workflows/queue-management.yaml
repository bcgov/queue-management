name: Queue Management
concurrency: 
  group: ${{ github.workflow }}
  cancel-in-progress: true
on:
  workflow_dispatch:

jobs:
  checkout:
    name: Check out
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out
      uses: actions/checkout@v2

  build-api:
    name: Build /api
    runs-on: ubuntu-latest

    steps:
    - name: build
      shell: bash
      run: |
        echo Build complete

  build-appointment-frontend:
    name: Build /appointment-frontend
    runs-on: ubuntu-latest

    steps:
    - name: build
      uses: ./.github/workflows/reusable-build-dockerfile.yaml
      with:
        directory: appointment-frontend
        image-name: appointment-frontend

  build-feedback-api:
    name: Build /feedback-api
    runs-on: ubuntu-latest

    steps:
    - name: build
      shell: bash
      run: |
        echo Build complete

  build-frontend:
    name: Build /frontend
    runs-on: ubuntu-latest

    steps:
    - name: build
      uses: ./.github/workflows/reusable-build-dockerfile.yaml@master
      with:
        directory: api
        image-name: queue-management-api

  build-jobs-appointment-reminder:
    name: Build /jobs/appointment-reminder
    runs-on: ubuntu-latest

    steps:
    - name: build
      shell: bash
      run: |
        echo Build complete

  build-notifications-api:
    name: Build /notifications-api
    runs-on: ubuntu-latest

    steps:
    - name: build
      shell: bash
      run: |
        echo Build complete

  deploy-theq-dev:
    name: Deploy to TheQ dev
    needs: [build-api, build-appointment-frontend, build-feedback-api, build-frontend, build-jobs-appointment-reminder, build-notifications-api]
    environment: theq-dev
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Deploy complete
 
  newman-theq-dev:
    name: Newman tests in TheQ dev
    needs: deploy-theq-dev
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Newman tests complete
 
  deploy-theq-test:
    name: Deploy to TheQ test
    needs: newman-theq-dev
    environment: theq-test
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Deploy complete
 
  deploy-theq-prod:
    name: Deploy to TheQ prod
    needs: deploy-theq-test
    environment: theq-prod
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Deploy complete
 
  deploy-qms-dev:
    name: Deploy to QMS dev
    needs: [build-api, build-frontend, build-jobs-appointment-reminder]
    environment: qms-dev
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Deploy complete
 
  newman-qms-dev:
    name: Newman tests in QMS dev
    needs: deploy-qms-dev
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Newman tests complete
 
  deploy-qms-test:
    name: Deploy to QMS test
    needs: newman-qms-dev
    environment: qms-test
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Deploy complete
 
  deploy-qms-prod:
    name: Deploy to QMS prod
    needs: deploy-qms-test
    environment: qms-prod
  
    runs-on: ubuntu-latest
    steps:
      - name: deploy
        shell: bash
        run: |
          echo Deploy complete
 
